<!DOCTYPE html>
<html lang="pt-br">
<head>
  <script>
  if (localStorage.getItem("logado") !== "true") {
    window.location.href = "login.html";
  }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="./fav.icons/tvnicon.png">
  <title>Configurações do Sistema</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    .config-section {
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .config-section h3 {
      margin-top: 0;
      color: var(--text-primary);
      border-bottom: 2px solid var(--button-primary);
      padding-bottom: 10px;
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .config-item {
      background-color: var(--table-row-even);
      padding: 20px;
      border-radius: 6px;
      border-left: 4px solid var(--button-primary);
    }

    .config-item h4 {
      margin-top: 0;
      color: var(--text-primary);
    }

    .config-item p {
      color: var(--text-secondary);
      margin-bottom: 15px;
    }

    .access-denied {
      text-align: center;
      padding: 50px;
      background-color: var(--secondary-bg);
      border-radius: 8px;
      margin: 20px;
    }

    .access-denied i {
      font-size: 4rem;
      color: var(--button-danger);
      margin-bottom: 20px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: var(--secondary-bg);
      margin: 5% auto;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-hover);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .close {
      color: var(--text-secondary);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: var(--text-primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .alert {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>

  <button class="mobile-menu-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>

  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <h2>Menu Principal</h2>
    <a href="listadeusuarios.html"><i class="fas fa-user-graduate"></i> Alunos</a>
    <a href="disciplinasnotas.html"><i class="fas fa-star"></i> Notas</a>
    <a href="disciplinasfrequencias.html"><i class="fas fa-clipboard-list"></i> Frequência</a>
    <a href="configprof.html" id="configLink"><i class="fas fa-cogs"></i> Configurações</a>
    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
  </div>

  <div class="main">
    <div class="header">
      <h1>
        <i class="fas fa-cogs" style="margin-right: 15px; color: var(--button-primary);"></i>
        Configurações do Sistema
      </h1>
      <div class="welcome">
        <i class="fas fa-user-circle" style="font-size: 2rem; margin-right: 10px;"></i>
        <span id="welcomeUser">Bem-vindo!</span>
      </div>
    </div>

    <!-- Conteúdo para Administradores -->
    <div id="adminContent" style="display: none;">
      
      <!-- Gerenciamento de Usuários -->
      <div class="config-section">
        <h3>
          <i class="fas fa-users"></i> Gerenciamento de Usuários
        </h3>
        <p>Controle total sobre usuários do sistema, incluindo professores e administradores.</p>
        
        <div class="controls">
          <button id="addUserBtn" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Adicionar Usuário
          </button>
          <button id="refreshUsersBtn" class="btn btn-warning">
            <i class="fas fa-sync"></i> Atualizar Lista
          </button>
          <button id="exportUsersBtn" class="btn btn-success">
            <i class="fas fa-download"></i> Exportar Dados
          </button>
        </div>

        <div class="stats-container" style="margin: 20px 0;">
          <div class="stat-card">
            <h3><i class="fas fa-users"></i> Total de Usuários</h3>
            <p class="stat-value" id="totalUsers">-</p>
            <p class="stat-description">Usuários cadastrados</p>
          </div>
          
          <div class="stat-card">
            <h3><i class="fas fa-user-check"></i> Usuários Ativos</h3>
            <p class="stat-value" id="activeUsers" style="color: var(--button-success);">-</p>
            <p class="stat-description">Usuários ativos no sistema</p>
          </div>
          
          <div class="stat-card">
            <h3><i class="fas fa-user-shield"></i> Administradores</h3>
            <p class="stat-value" id="adminUsers" style="color: var(--button-danger);">-</p>
            <p class="stat-description">Usuários com perfil admin</p>
          </div>
          
          <div class="stat-card">
            <h3><i class="fas fa-chalkboard-teacher"></i> Professores</h3>
            <p class="stat-value" id="professorUsers" style="color: var(--button-primary);">-</p>
            <p class="stat-description">Usuários com perfil professor</p>
          </div>
        </div>

        <div id="alertContainer"></div>

        <div id="usersContainer">
          <!-- Usuários serão carregados dinamicamente -->
        </div>
      </div>

      <!-- Configurações do Sistema -->
      <div class="config-section">
        <h3>
          <i class="fas fa-server"></i> Configurações do Sistema
        </h3>
        
        <div class="config-grid">
          <div class="config-item">
            <h4><i class="fas fa-database"></i> Backup de Dados</h4>
            <p>Faça backup de todos os dados do sistema</p>
            <button class="btn btn-success" onclick="backupData()">
              <i class="fas fa-download"></i> Fazer Backup
            </button>
          </div>

          <div class="config-item">
            <h4><i class="fas fa-upload"></i> Restaurar Dados</h4>
            <p>Restaure dados de um backup anterior</p>
            <input type="file" id="restoreFile" accept=".json" style="display: none;">
            <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">
              <i class="fas fa-upload"></i> Restaurar
            </button>
          </div>

          <div class="config-item">
            <h4><i class="fas fa-trash-alt"></i> Limpar Dados</h4>
            <p>Remove todos os dados e reinicia o sistema</p>
            <button class="btn btn-danger" onclick="resetSystem()">
              <i class="fas fa-trash-alt"></i> Resetar Sistema
            </button>
          </div>

          <div class="config-item">
            <h4><i class="fas fa-info-circle"></i> Informações</h4>
            <p>Versão do sistema e estatísticas</p>
            <button class="btn btn-secondary" onclick="showSystemInfo()">
              <i class="fas fa-info-circle"></i> Ver Informações
            </button>
          </div>
        </div>
      </div>

    </div>

    <!-- Acesso Negado para Professores -->
    <div id="accessDenied" class="access-denied" style="display: none;">
      <i class="fas fa-lock"></i>
      <h2>Acesso Restrito</h2>
      <p>Esta seção é exclusiva para administradores do sistema.</p>
      <p>Entre em contato com um administrador se precisar de acesso.</p>
      <button class="btn btn-primary" onclick="window.location.href='telainicial.html'">
        <i class="fas fa-home"></i> Voltar ao Início
      </button>
    </div>

  </div>

  <!-- Modal para adicionar/editar usuário -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">
          <i class="fas fa-user-plus"></i> Adicionar Usuário
        </h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div id="modalAlert"></div>
      
      <form id="userForm">
        <input type="hidden" id="userId" name="userId">
        
        <div class="form-row">
          <div class="input-group">
            <label for="userName">
              <i class="fas fa-user"></i> Nome Completo:
            </label>
            <input type="text" id="userName" name="name" required>
          </div>
          
          <div class="input-group">
            <label for="userUsername">
              <i class="fas fa-at"></i> Nome de Usuário:
            </label>
            <input type="text" id="userUsername" name="username" required>
          </div>
        </div>

        <div class="input-group">
          <label for="userEmail">
            <i class="fas fa-envelope"></i> Email:
          </label>
          <input type="email" id="userEmail" name="email" required>
        </div>
        
        <div class="form-row">
          <div class="input-group">
            <label for="userRole">
              <i class="fas fa-user-tag"></i> Tipo de Usuário:
            </label>
            <select id="userRole" name="role" required>
              <option value="">Selecione o tipo</option>
              <option value="professor">Professor</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="userActive">
              <i class="fas fa-toggle-on"></i> Status:
            </label>
            <select id="userActive" name="active" required>
              <option value="true">Ativo</option>
              <option value="false">Inativo</option>
            </select>
          </div>
        </div>

        <div id="passwordFields">
          <div class="form-row">
            <div class="input-group">
              <label for="userPassword">
                <i class="fas fa-lock"></i> Senha:
              </label>
              <input type="password" id="userPassword" name="password">
            </div>
            
            <div class="input-group">
              <label for="userConfirmPassword">
                <i class="fas fa-lock"></i> Confirmar Senha:
              </label>
              <input type="password" id="userConfirmPassword" name="confirmPassword">
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            <i class="fas fa-save"></i> Salvar
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <footer class="footer">
    <span>© 2025 - Todos os direitos reservados</span>
    <span>XBIUDERS MDD DO DEV</span>
  </footer>

  <script src="js/auth-manager.js"></script>
  <script>
    let isEditMode = false;

    // Inicialização da página
    document.addEventListener('DOMContentLoaded', function() {
      const currentUser = authManager.getCurrentUser();
      
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      // Atualiza mensagem de boas-vindas
      document.getElementById('welcomeUser').textContent = `Bem-vindo, ${currentUser.name}!`;

      // Verifica permissões
      if (authManager.isAdmin()) {
        document.getElementById('adminContent').style.display = 'block';
        loadUsers();
        updateStats();
      } else {
        document.getElementById('accessDenied').style.display = 'block';
      }
    });

    // Carrega lista de usuários
    function loadUsers() {
      const users = authManager.getAllUsers();
      const container = document.getElementById('usersContainer');
      
      if (users.length === 0) {
        container.innerHTML = `
          <div class="card" style="text-align: center; padding: 40px;">
            <i class="fas fa-users" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
            <h3>Nenhum usuário encontrado</h3>
            <p>Clique em "Adicionar Usuário" para começar.</p>
          </div>
        `;
        return;
      }

      let html = '';
      users.forEach(user => {
        html += `
          <div class="user-card" style="background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div>
                <h3 style="margin: 0; color: var(--text-primary);">
                  <i class="fas fa-user"></i> ${user.name}
                </h3>
                <div style="margin-top: 5px;">
                  <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; background-color: var(--button-${user.role === 'admin' ? 'danger' : 'primary'}); color: var(--text-white);">
                    <i class="fas fa-${user.role === 'admin' ? 'user-shield' : 'chalkboard-teacher'}"></i>
                    ${user.role === 'admin' ? 'Administrador' : 'Professor'}
                  </span>
                  <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; background-color: var(--button-${user.active ? 'success' : 'secondary'}); color: var(--text-white);">
                    <i class="fas fa-${user.active ? 'check-circle' : 'times-circle'}"></i>
                    ${user.active ? 'Ativo' : 'Inativo'}
                  </span>
                </div>
              </div>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="editUser('${user.id}')" style="padding: 8px 12px;">
                  <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn btn-danger" onclick="deleteUser('${user.id}')" style="padding: 8px 12px;">
                  <i class="fas fa-trash"></i> Excluir
                </button>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <strong><i class="fas fa-at"></i> Usuário:</strong><br>
                ${user.username}
              </div>
              <div>
                <strong><i class="fas fa-envelope"></i> Email:</strong><br>
                ${user.email}
              </div>
              <div>
                <strong><i class="fas fa-calendar"></i> Criado em:</strong><br>
                ${new Date(user.createdAt).toLocaleDateString('pt-BR')}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Atualiza estatísticas
    function updateStats() {
      const stats = authManager.getUserStats();
      
      document.getElementById('totalUsers').textContent = stats.total;
      document.getElementById('activeUsers').textContent = stats.active;
      document.getElementById('adminUsers').textContent = stats.admins;
      document.getElementById('professorUsers').textContent = stats.professors;
    }

    // Abre modal para adicionar usuário
    function openAddUserModal() {
      isEditMode = false;
      document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Adicionar Usuário';
      document.getElementById('userForm').reset();
      document.getElementById('userId').value = '';
      document.getElementById('passwordFields').style.display = 'block';
      document.getElementById('userPassword').required = true;
      document.getElementById('userConfirmPassword').required = true;
      clearModalAlert();
      document.getElementById('userModal').style.display = 'block';
    }

    // Edita usuário
    function editUser(userId) {
      const user = authManager.getUser(userId);
      if (!user) {
        showAlert('alertContainer', 'Usuário não encontrado.', 'error');
        return;
      }

      isEditMode = true;
      document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Usuário';
      document.getElementById('userId').value = user.id;
      document.getElementById('userName').value = user.name;
      document.getElementById('userUsername').value = user.username;
      document.getElementById('userEmail').value = user.email;
      document.getElementById('userRole').value = user.role;
      document.getElementById('userActive').value = user.active.toString();
      
      // Oculta campos de senha na edição
      document.getElementById('passwordFields').style.display = 'none';
      document.getElementById('userPassword').required = false;
      document.getElementById('userConfirmPassword').required = false;
      
      clearModalAlert();
      document.getElementById('userModal').style.display = 'block';
    }

    // Exclui usuário
    function deleteUser(userId) {
      const user = authManager.getUser(userId);
      if (!user) {
        showAlert('alertContainer', 'Usuário não encontrado.', 'error');
        return;
      }

      if (confirm(`Tem certeza que deseja excluir o usuário "${user.name}"?`)) {
        const result = authManager.deleteUser(userId);
        
        if (result.success) {
          showAlert('alertContainer', result.message, 'success');
          loadUsers();
          updateStats();
        } else {
          showAlert('alertContainer', result.message, 'error');
        }
      }
    }

    // Fecha modal
    function closeModal() {
      document.getElementById('userModal').style.display = 'none';
      clearModalAlert();
    }

    // Mostra alerta
    function showAlert(containerId, message, type = 'error') {
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <div class="alert alert-${type}">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
          ${message}
        </div>
      `;
      
      // Remove alerta após 5 segundos
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    // Limpa alerta do modal
    function clearModalAlert() {
      document.getElementById('modalAlert').innerHTML = '';
    }

    // Funções do sistema
    function backupData() {
      const data = {
        users: authManager.exportUsers(),
        grades: localStorage.getItem('sistema_notas') || '{}',
        attendance: localStorage.getItem('sistema_frequencia') || '{}',
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_sistema_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showAlert('alertContainer', 'Backup realizado com sucesso!', 'success');
    }

    function resetSystem() {
      if (confirm('ATENÇÃO: Esta ação irá apagar todos os dados do sistema. Tem certeza?')) {
        if (confirm('Esta ação é irreversível. Confirma o reset completo?')) {
          authManager.resetSystem();
          localStorage.clear();
          alert('Sistema resetado com sucesso! Você será redirecionado para o login.');
          window.location.href = 'login.html';
        }
      }
    }

    function showSystemInfo() {
      const stats = authManager.getUserStats();
      const info = `
        Sistema de Diário Eletrônico v2.0
        
        Estatísticas:
        - Total de usuários: ${stats.total}
        - Usuários ativos: ${stats.active}
        - Administradores: ${stats.admins}
        - Professores: ${stats.professors}
        
        Desenvolvido por: XBIUDERS MDD DO DEV
        © 2025 - Todos os direitos reservados
      `;
      alert(info);
    }

    // Event Listeners
    document.getElementById('addUserBtn').addEventListener('click', openAddUserModal);

    document.getElementById('refreshUsersBtn').addEventListener('click', function() {
      loadUsers();
      updateStats();
      showAlert('alertContainer', 'Lista atualizada com sucesso!', 'success');
    });

    document.getElementById('exportUsersBtn').addEventListener('click', function() {
      const data = authManager.exportUsers();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `usuarios_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showAlert('alertContainer', 'Dados exportados com sucesso!', 'success');
    });

    // Form de usuário
    document.getElementById('userForm').addEventListener('submit', function(e) {
      e.preventDefault();
      clearModalAlert();
      
      const formData = new FormData(this);
      const userData = {
        name: formData.get('name'),
        username: formData.get('username'),
        email: formData.get('email'),
        role: formData.get('role'),
        active: formData.get('active') === 'true'
      };

      if (!isEditMode) {
        // Adicionar usuário
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');
        
        if (!password || !confirmPassword) {
          showAlert('modalAlert', 'Por favor, preencha todos os campos.', 'error');
          return;
        }

        if (password !== confirmPassword) {
          showAlert('modalAlert', 'As senhas não coincidem.', 'error');
          return;
        }

        userData.password = password;
        const result = authManager.register(userData);
        
        if (result.success) {
          showAlert('modalAlert', result.message, 'success');
          setTimeout(() => {
            closeModal();
            loadUsers();
            updateStats();
            showAlert('alertContainer', 'Usuário adicionado com sucesso!', 'success');
          }, 1500);
        } else {
          showAlert('modalAlert', result.message, 'error');
        }
      } else {
        // Editar usuário
        const userId = formData.get('userId');
        const result = authManager.updateUser(userId, userData);
        
        if (result.success) {
          showAlert('modalAlert', result.message, 'success');
          setTimeout(() => {
            closeModal();
            loadUsers();
            updateStats();
            showAlert('alertContainer', 'Usuário atualizado com sucesso!', 'success');
          }, 1500);
        } else {
          showAlert('modalAlert', result.message, 'error');
        }
      }
    });

    // Fecha modal ao clicar fora
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('userModal');
      if (event.target === modal) {
        closeModal();
      }
    });

    // Restaurar dados
    document.getElementById('restoreFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            if (confirm('Tem certeza que deseja restaurar os dados? Isso substituirá todos os dados atuais.')) {
              if (data.users) {
                authManager.importUsers(data.users);
              }
              if (data.grades) {
                localStorage.setItem('sistema_notas', data.grades);
              }
              if (data.attendance) {
                localStorage.setItem('sistema_frequencia', data.attendance);
              }
              showAlert('alertContainer', 'Dados restaurados com sucesso!', 'success');
              loadUsers();
              updateStats();
            }
          } catch (error) {
            showAlert('alertContainer', 'Erro ao ler arquivo de backup.', 'error');
          }
        };
        reader.readAsText(file);
      }
    });

    function logout() {
      authManager.logout();
      window.location.href = "login.html";
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
  </script>

</body>
</html>

